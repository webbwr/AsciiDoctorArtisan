#!/usr/bin/env bash
# Wrapper script for grandmaster-techwriter skill
# Usage: ./scripts/tw [command] [file]
#
# Commands:
#   check [file]    - Check readability of file
#   improve [file]  - Apply grandmaster techwriter to improve file
#   watch [file]    - Watch file and check on changes
#   help           - Show this help

set -euo pipefail

SKILL_FILE=".claude/skills/grandmaster-techwriter.md"
READABILITY_SCRIPT="scripts/readability_check.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo "Grandmaster TechWriter (TW) - Grade 5.0 Documentation Tool"
    echo ""
    echo "Usage: ./scripts/tw [command] [file]"
    echo ""
    echo "Commands:"
    echo "  check FILE      Check readability of FILE"
    echo "  improve FILE    Apply improvements to FILE (interactive)"
    echo "  watch FILE      Watch FILE and check on changes"
    echo "  batch DIR       Check all .md files in DIR"
    echo "  help            Show this help"
    echo ""
    echo "Examples:"
    echo "  ./scripts/tw check README.md"
    echo "  ./scripts/tw improve docs/guide.md"
    echo "  ./scripts/tw batch docs/"
    echo ""
    echo "Aliases: tw, techwriter, grade5"
}

check_readability() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        echo -e "${RED}Error: File not found: $file${NC}" >&2
        exit 1
    fi
    
    echo -e "${BLUE}Checking readability: $file${NC}"
    python3 "$READABILITY_SCRIPT" "$file"
}

improve_file() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        echo -e "${RED}Error: File not found: $file${NC}" >&2
        exit 1
    fi
    
    echo -e "${YELLOW}Applying grandmaster-techwriter to: $file${NC}"
    echo ""
    echo "This will:"
    echo "1. Check current readability"
    echo "2. Apply MA (minimalism) principles"
    echo "3. Add Socratic questions where helpful"
    echo "4. Simplify complex sentences"
    echo "5. Verify Grade ≤5.0"
    echo ""
    
    # First check current state
    echo -e "${BLUE}=== BEFORE ===${NC}"
    python3 "$READABILITY_SCRIPT" "$file" || true
    
    echo ""
    echo -e "${GREEN}Review the skill file for methodology:${NC}"
    echo "  cat $SKILL_FILE"
    echo ""
    echo "Manual application recommended for now."
    echo "Auto-improvement coming in future version."
}

watch_file() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        echo -e "${RED}Error: File not found: $file${NC}" >&2
        exit 1
    fi
    
    echo -e "${BLUE}Watching: $file${NC}"
    echo "Press Ctrl+C to stop"
    echo ""
    
    # Check once at start
    check_readability "$file"
    
    # Watch for changes (requires inotify-tools on Linux)
    if command -v inotifywait &> /dev/null; then
        while inotifywait -e modify "$file" 2>/dev/null; do
            echo ""
            echo -e "${YELLOW}File changed, rechecking...${NC}"
            check_readability "$file"
        done
    else
        echo -e "${YELLOW}Install inotify-tools for file watching${NC}"
        echo "  sudo apt install inotify-tools"
    fi
}

batch_check() {
    local dir="$1"
    if [[ ! -d "$dir" ]]; then
        echo -e "${RED}Error: Directory not found: $dir${NC}" >&2
        exit 1
    fi
    
    echo -e "${BLUE}Batch checking all .md files in: $dir${NC}"
    echo ""
    
    local count=0
    local passed=0
    local failed=0
    
    while IFS= read -r -d '' file; do
        ((count++))
        echo -e "${YELLOW}[$count] Checking: $file${NC}"
        if python3 "$READABILITY_SCRIPT" "$file" 2>&1 | grep -q "✓ PASS"; then
            ((passed++))
            echo -e "${GREEN}  ✓ PASS${NC}"
        else
            ((failed++))
            echo -e "${RED}  ✗ FAIL${NC}"
        fi
        echo ""
    done < <(find "$dir" -name "*.md" -type f -print0)
    
    echo "================================"
    echo "Summary: $count files checked"
    echo -e "${GREEN}Passed: $passed${NC}"
    echo -e "${RED}Failed: $failed${NC}"
}

# Main command dispatcher
case "${1:-help}" in
    check)
        check_readability "${2:-}"
        ;;
    improve)
        improve_file "${2:-}"
        ;;
    watch)
        watch_file "${2:-}"
        ;;
    batch)
        batch_check "${2:-}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}" >&2
        echo ""
        show_help
        exit 1
        ;;
esac
