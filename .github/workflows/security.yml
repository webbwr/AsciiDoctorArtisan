# =============================================================================
# GitHub Actions Workflow: Automated Dependency Security Scanning
# =============================================================================
#
# Purpose: Detect known security vulnerabilities in Python dependencies
#
# Tools Used:
#   - Safety: Scans against Safety DB (curated vulnerability database)
#   - pip-audit: Scans against OSV (Open Source Vulnerabilities database)
#
# Scanning Strategy:
#   - Dual scanning for comprehensive coverage (different databases)
#   - Non-blocking: Reports vulnerabilities but doesn't fail PRs
#   - Scheduled weekly scans to catch newly disclosed vulnerabilities
#   - Artifacts uploaded for historical tracking
#
# =============================================================================

name: Security Scanning

# Trigger conditions
on:
  # Run on pushes to main/dev branches
  push:
    branches: [ main, dev ]

  # Run on pull requests targeting main/dev
  pull_request:
    branches: [ main, dev ]

  # Weekly scheduled scan (Sunday at midnight UTC)
  # Catches newly disclosed vulnerabilities between releases
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual workflow dispatch for ad-hoc scans
  workflow_dispatch:

# Ensure only one security scan runs at a time per branch
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Job 1: Safety Security Scan
  # ===========================================================================
  #
  # Safety checks dependencies against the Safety DB, a curated database of
  # known security vulnerabilities in Python packages. It's particularly good
  # at catching common CVEs in popular packages.
  #
  # Database: https://github.com/pyupio/safety-db
  # ===========================================================================

  safety-check:
    name: Safety Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate dependency analysis
          fetch-depth: 0

      # Step 2: Set up Python environment
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # Cache pip packages for faster workflow execution
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # Step 3: Install Safety scanner
      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety

      # Step 4: Install project dependencies
      # Safety needs to scan the actual installed packages
      - name: Install project dependencies
        run: |
          pip install -r requirements.txt
        continue-on-error: true

      # Step 5: Run Safety security scan
      # --json: Output in JSON format for artifact upload
      # --continue-on-error: Don't fail the workflow, just report
      - name: Run Safety scan
        id: safety_scan
        run: |
          echo "Running Safety security scan..."
          safety check --json > safety-report.json || true
          safety check || echo "::warning::Safety found vulnerabilities"
        continue-on-error: true

      # Step 6: Generate human-readable report
      - name: Generate Safety summary
        if: always()
        run: |
          echo "## Safety Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f safety-report.json ]; then
            # Check if vulnerabilities were found
            vuln_count=$(jq '. | length' safety-report.json 2>/dev/null || echo "0")

            if [ "$vuln_count" -gt 0 ]; then
              echo "âš ï¸ **$vuln_count vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "See uploaded artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # Step 7: Upload scan results as artifact
      # Artifacts are kept for 30 days for historical tracking
      - name: Upload Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-security-report
          path: safety-report.json
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # Job 2: pip-audit Security Scan
  # ===========================================================================
  #
  # pip-audit checks dependencies against the OSV (Open Source Vulnerabilities)
  # database. OSV aggregates data from multiple sources including GitHub
  # Security Advisories, PyPA, and more. Complements Safety with broader
  # coverage.
  #
  # Database: https://osv.dev
  # ===========================================================================

  pip-audit-check:
    name: pip-audit Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1: Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Set up Python environment
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # Step 3: Install pip-audit scanner
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      # Step 4: Install project dependencies
      - name: Install project dependencies
        run: |
          pip install -r requirements.txt
        continue-on-error: true

      # Step 5: Run pip-audit security scan
      # --format json: Output in JSON format for parsing
      # --desc: Include vulnerability descriptions
      - name: Run pip-audit scan
        id: pip_audit_scan
        run: |
          echo "Running pip-audit security scan..."
          pip-audit --format json --desc > pip-audit-report.json || true
          pip-audit || echo "::warning::pip-audit found vulnerabilities"
        continue-on-error: true

      # Step 6: Generate human-readable report
      - name: Generate pip-audit summary
        if: always()
        run: |
          echo "## pip-audit Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f pip-audit-report.json ]; then
            # Check if vulnerabilities were found
            vuln_count=$(jq '.dependencies | length' pip-audit-report.json 2>/dev/null || echo "0")

            if [ "$vuln_count" -gt 0 ]; then
              echo "âš ï¸ **$vuln_count packages with vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "See uploaded artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # Step 7: Upload scan results as artifact
      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-security-report
          path: pip-audit-report.json
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # Job 3: Security Scan Summary
  # ===========================================================================
  #
  # Aggregates results from both scanners and creates a unified report.
  # This job runs after both scanners complete (regardless of success/failure).
  # ===========================================================================

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [safety-check, pip-audit-check]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Generate unified summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Safety results
          if [ -f security-reports/safety-security-report/safety-report.json ]; then
            safety_vulns=$(jq '. | length' security-reports/safety-security-report/safety-report.json 2>/dev/null || echo "0")
            echo "### Safety Scan" >> $GITHUB_STEP_SUMMARY
            if [ "$safety_vulns" -gt 0 ]; then
              echo "âš ï¸ Found $safety_vulns vulnerabilities" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # pip-audit results
          if [ -f security-reports/pip-audit-security-report/pip-audit-report.json ]; then
            audit_vulns=$(jq '.dependencies | length' security-reports/pip-audit-security-report/pip-audit-report.json 2>/dev/null || echo "0")
            echo "### pip-audit Scan" >> $GITHUB_STEP_SUMMARY
            if [ "$audit_vulns" -gt 0 ]; then
              echo "âš ï¸ Found $audit_vulns packages with vulnerabilities" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Review detailed reports in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Check vulnerability severity and affected versions" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies where possible" >> $GITHUB_STEP_SUMMARY
          echo "- Create issues for vulnerabilities requiring investigation" >> $GITHUB_STEP_SUMMARY
