# AsciiDoc Artisan v2.0.5 Development Plan

**Version:** 2.0.5
**Status:** PLANNING
**Target Date:** Dec 2025
**Effort Estimate:** 1-2 weeks
**Focus:** Testing improvements, coverage targets, documentation

---

## Overview

v2.0.5 is a **quality and testing** release focused on achieving coverage targets, documenting limitations, and improving test health. This is a maintenance release building on v2.0.4's test health improvements.

**Key Goals:**
1. ‚úÖ Achieve 85% main_window.py coverage (currently 84.8%, need +0.2%)
2. ‚úÖ Document all Qt threading limitation tests
3. ‚úÖ Review and validate defensive code removal decisions
4. ‚úÖ E2E test suite improvements
5. ‚úÖ Integration test health (async tests resolved)

---

## 1. Main Window Coverage Target (4-6 hours)

### Current Status
- **Current Coverage:** 84.8%
- **Target Coverage:** 85.0%
- **Gap:** +0.2% (approximately 3-5 lines)
- **File:** `src/asciidoc_artisan/ui/main_window.py` (1,798 lines)

### Strategy
- **Phase 4G**: Targeted coverage improvements for main_window.py
- **Approach**: Identify uncovered lines using coverage report
- **Tests needed**: Approximately 2-4 new tests

### Action Items
1. Run coverage analysis on main_window.py
2. Identify uncovered code paths (likely edge cases)
3. Write targeted tests for uncovered lines
4. Verify 85% target reached
5. Document any lines that cannot be covered (Qt limitations)

### Success Criteria
- ‚úÖ main_window.py coverage ‚â• 85.0%
- ‚úÖ All new tests passing
- ‚úÖ No regression in existing tests
- ‚úÖ Documentation of uncoverable lines

---

## 2. Qt Threading Limitations Documentation (2-3 hours)

### Current Status
- **Documented**: 1 async test (test_save_file_creates_file_async)
- **Undocumented**: Multiple Qt threading limitation tests across codebase

### Files to Review
1. `tests/unit/workers/test_optimized_worker_pool.py` - QRunnable.run() limitations
2. `tests/unit/claude/test_claude_worker.py` - QThread.run() limitations
3. `tests/unit/ui/test_spell_check_manager.py` - QMenu.exec() blocking
4. `tests/unit/ui/test_dialog_manager.py` - QAction parent validation
5. Any other tests with Qt-specific skip markers

### Action Items
1. Inventory all skipped tests with Qt-related reasons
2. Create comprehensive Qt limitations document
3. Add detailed skip reasons to each test
4. Cross-reference with Qt documentation
5. Document alternative testing approaches for each

### Deliverable
**File:** `docs/testing/QT_THREADING_LIMITATIONS.md`

**Contents:**
- Overview of Qt threading model
- Python `sys.settrace()` limitations with Qt C++ threads
- List of all affected tests with detailed explanations
- Alternative testing strategies
- Links to Qt official documentation
- Code examples showing the limitation
- Recommendations for future work

### Success Criteria
- ‚úÖ All Qt-limited tests documented
- ‚úÖ Clear explanations for each limitation
- ‚úÖ Alternative testing approaches identified
- ‚úÖ Referenced in test skip reasons

---

## 3. Defensive Code Review (3-4 hours)

### Context
From CLAUDE.md:
> **‚ùå Unreachable defensive code** ‚Üí remove or document

The codebase has been modernized with comprehensive error handling, but some defensive code may be unreachable due to inner try-except blocks catching all exceptions.

### Review Areas
1. **Nested try-except blocks**
   - Inner catch-all handlers making outer handlers unreachable
   - Example pattern: `try: try: json.loads() except: pass except: pass` ‚Üê outer unreachable

2. **Type guard code after validation**
   - Code that checks types after mypy --strict validation
   - May be defensive for runtime but unreachable in typed context

3. **Impossible conditions**
   - `if x is None` after already checking `if x`
   - Conditions that can never be True due to earlier logic

### Action Items
1. Run coverage analysis to identify uncovered defensive code
2. For each unreachable block:
   - **Option A:** Remove if truly unreachable
   - **Option B:** Document why it's kept (future-proofing, runtime safety)
   - **Option C:** Refactor to make it reachable (if needed)
3. Add `# pragma: no cover` comments for intentionally unreachable code
4. Update tests to cover previously defensive code if now reachable

### Review Process
```bash
# Find uncovered defensive code
pytest tests/ --cov=asciidoc_artisan --cov-report=term-missing --cov-report=html

# Open coverage report
open htmlcov/index.html

# For each module <90% coverage:
#   1. Identify uncovered lines
#   2. Determine if defensive or missing test
#   3. Apply Option A, B, or C above
```

### Validation Criteria
For each defensive code block, answer:
1. **Can this condition ever occur?** (Check with type checker, logic flow)
2. **Does mypy --strict prevent this condition?** (If yes, likely unreachable)
3. **Is there a test path that reaches this code?** (If no, unreachable)
4. **Should this stay for runtime safety?** (Document if yes)

### Deliverable
**File:** `docs/developer/DEFENSIVE_CODE_AUDIT.md`

**Contents:**
- List of all reviewed defensive code
- Decision (Remove/Document/Refactor) for each
- Rationale for keeping intentionally unreachable code
- Coverage impact summary

### Success Criteria
- ‚úÖ All unreachable defensive code identified
- ‚úÖ Each block reviewed and decision made
- ‚úÖ Intentional unreachable code documented with `# pragma: no cover`
- ‚úÖ No coverage regression
- ‚úÖ mypy --strict still passing

---

## 4. E2E Test Suite Improvements (4-6 hours)

### Current Status (from TESTING_SESSION_SUMMARY.md)
- **Created:** `tests/e2e/test_e2e_workflows.py` (6 workflows)
- **Results:** 4 passed, 2 failed (Qt multi-instance segfaults)
- **Issue:** Qt crashes when creating multiple QApplication instances

### Action Items
1. **Fix Qt multi-instance issues**
   - Option A: Use pytest-forked to isolate each test in subprocess
   - Option B: Refactor fixture to reuse single QApplication
   - Option C: Mark problematic tests with proper skip documentation

2. **Add more workflows**
   - Collaborative editing scenario (git branches)
   - Export workflow (all formats sequentially)
   - Theme switching workflow
   - Settings modification workflow

3. **Improve test stability**
   - Add proper teardown for Qt objects
   - Increase timeout values for CI environments
   - Mock external dependencies (pandoc, wkhtmltopdf)

4. **Performance benchmarking**
   - Measure E2E workflow completion times
   - Set performance regression thresholds
   - Add to CI if stable

### Success Criteria
- ‚úÖ All 6 existing E2E tests passing
- ‚úÖ 2-4 additional workflows added
- ‚úÖ No Qt segfaults
- ‚úÖ Documented as part of test suite

---

## 5. Integration Test Health (COMPLETED ‚úÖ)

### Summary
From TESTING_SESSION_SUMMARY.md:
- ‚úÖ **Fixed:** 2 skipped async tests now passing
  - `test_chat_visibility_control`
  - `test_worker_response_connection`
- ‚úÖ **Documented:** 1 Qt limitation test
  - `test_save_file_creates_file_async`
- ‚úÖ **Results:** 174 tests passed, 1 skipped, 0 failed (99.43% pass rate)

**No additional work needed for v2.0.5.**

---

## Version Metadata

### Test Suite Targets
| Metric | Current (v2.0.4) | Target (v2.0.5) | Status |
|--------|------------------|-----------------|--------|
| Total tests | 5,482 | 5,490+ | üìä +8-10 tests |
| Pass rate | 99.89% | 99.9%+ | üìà Improvement |
| Coverage | 91.7% | 92-93% | üìà +0.3-0.6% |
| main_window.py | 84.8% | 85.0%+ | üéØ Primary goal |
| E2E tests | 4/6 passing | 6+/8+ passing | üîß Stability |
| Qt limitations | 1 documented | All documented | üìù Complete |

### Deliverables Checklist
- [ ] main_window.py ‚â• 85% coverage
- [ ] `docs/testing/QT_THREADING_LIMITATIONS.md`
- [ ] `docs/developer/DEFENSIVE_CODE_AUDIT.md`
- [ ] E2E tests: 6+ passing, no segfaults
- [ ] Integration tests: maintain 99%+ pass rate
- [ ] All quality checks passing (ruff, mypy --strict)
- [ ] Updated ROADMAP.md with v2.0.5 entry
- [ ] Release notes in CHANGELOG.md

### Effort Breakdown
| Task | Estimated Hours | Priority |
|------|-----------------|----------|
| Main window coverage | 4-6h | HIGH |
| Qt limitations doc | 2-3h | HIGH |
| Defensive code review | 3-4h | MEDIUM |
| E2E test fixes | 4-6h | MEDIUM |
| Documentation updates | 2h | LOW |
| **Total** | **15-21h** | **1-2 weeks** |

### Success Criteria (v2.0.5 Release)
- ‚úÖ All deliverables complete
- ‚úÖ Test suite stability maintained (99%+ pass rate)
- ‚úÖ No regressions in coverage or type safety
- ‚úÖ All documentation updated
- ‚úÖ mypy --strict: 0 errors
- ‚úÖ Pre-commit hooks: all passing

---

## Post-Release Planning

### v2.0.6+ Considerations
- **Phase 4E Continuation**: UI layer coverage (90-95% ‚Üí 99-100%)
  - Estimated: 2-6 weeks, ~150-200 tests
  - Would bring overall coverage to ~95-96%
- **Performance Optimizations**: Startup time, memory usage
- **Feature Enhancements**: User-requested features from GitHub issues
- **Dependency Updates**: PySide6, Python 3.13 compatibility

### v3.0.0 Vision (Q4 2026-Q2 2027)
Per ROADMAP.md:
- LSP (Language Server Protocol) integration
- Plugin architecture and marketplace
- Multi-core rendering
- Enhanced extensibility

---

## References

- **ROADMAP.md**: Overall project roadmap
- **TESTING_SESSION_SUMMARY.md**: Nov 18, 2025 testing session results
- **SPECIFICATIONS_AI.md**: 107 functional requirements
- **CLAUDE.md**: Development patterns and critical issues
- **docs/developer/phase-4c-coverage-plan.md**: Coverage improvement tracking

---

*Plan created: 2025-11-18*
*Status: DRAFT - Ready for review*
*Next update: After v2.0.5 release*
