# v2.0.0 Auto-Complete Implementation Plan

**Feature:** AsciiDoc Auto-Complete System
**Target:** <50ms response, 100% test coverage
**Effort Estimate:** 24-32 hours
**Status:** ðŸ“‹ PLANNING

---

## Executive Summary

Implement intelligent auto-completion for AsciiDoc syntax, attributes, cross-references, includes, and custom snippets. The system must provide sub-50ms response times with comprehensive test coverage while maintaining the application's fast startup time.

---

## Requirements

### Functional Requirements

1. **Syntax Completion**
   - Headings: `=`, `==`, `===`, etc.
   - Lists: `*`, `-`, `.`, numbered lists
   - Blocks: `[source]`, `[NOTE]`, `[TIP]`, `[IMPORTANT]`, `[WARNING]`, `[CAUTION]`
   - Inline: `*bold*`, `_italic_`, `` `monospace` ``, `^superscript^`, `~subscript~`
   - Links: `link:`, `https://`, `mailto:`
   - Images: `image::`, `image:`
   - Tables: `|===`, table cell separators

2. **Attribute Completion**
   - Document attributes: `:author:`, `:revnumber:`, `:toc:`, `:icons:`, etc.
   - Common attributes: `:source-highlighter:`, `:doctype:`, `:backend:`
   - Custom attribute references: `{attr}`

3. **Cross-Reference Completion**
   - Section IDs: `<<section-id>>`
   - Anchor references: `<<anchor>>`
   - xref: `xref:target[text]`

4. **Include Completion**
   - File paths: `include::path/to/file.adoc[]`
   - Relative path suggestions based on current file location
   - File extension filtering (.adoc, .txt)

5. **Snippet Expansion**
   - Common patterns with tab/enter expansion
   - Examples: `table3x3`, `codeblock`, `noteblock`, `warning`
   - User-defined custom snippets (future enhancement)

### Non-Functional Requirements

1. **Performance**
   - Response time: <50ms from trigger to display
   - No impact on typing latency
   - Minimal memory footprint (<5MB)
   - No startup time regression

2. **Usability**
   - Trigger: `Ctrl+Space` (manual) + automatic triggers (`:`, `[`, `<`)
   - Arrow keys for navigation
   - Enter/Tab for selection
   - Escape to dismiss
   - Fuzzy matching support

3. **Quality**
   - 100% test coverage for completion engine
   - Type-safe implementation (mypy --strict)
   - Comprehensive documentation

---

## Technical Architecture

### Component Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LineNumberedTextEdit (Editor)          â”‚
â”‚  - Key press event handler                      â”‚
â”‚  - Cursor position tracking                     â”‚
â”‚  - Completion trigger detection                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ keyPressEvent
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       AutoCompleteManager (Controller)          â”‚
â”‚  - Manages QCompleter lifecycle                 â”‚
â”‚  - Coordinates completion sources               â”‚
â”‚  - Filters and ranks suggestions                â”‚
â”‚  - Handles selection and insertion              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ query_completions(context)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CompletionEngine (Business Logic)          â”‚
â”‚  - Context analysis (syntax, position)          â”‚
â”‚  - Multi-source aggregation                     â”‚
â”‚  - Fuzzy matching and ranking                   â”‚
â”‚  - Result filtering and deduplication           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ get_completions_for_context()
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼                 â–¼             â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SyntaxProviderâ”‚ â”‚AttrProvider  â”‚ â”‚Xref  â”‚ â”‚Include â”‚
â”‚- Headings    â”‚ â”‚- Doc attrs   â”‚ â”‚- IDs â”‚ â”‚- Files â”‚
â”‚- Lists       â”‚ â”‚- Built-in    â”‚ â”‚      â”‚ â”‚        â”‚
â”‚- Blocks      â”‚ â”‚- Custom      â”‚ â”‚      â”‚ â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Structure

```
src/asciidoc_artisan/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ completion/
â”‚   â”‚   â”œâ”€â”€ __init__.py                  # Public API exports
â”‚   â”‚   â”œâ”€â”€ completion_engine.py         # Core completion logic
â”‚   â”‚   â”œâ”€â”€ completion_context.py        # Context analysis
â”‚   â”‚   â”œâ”€â”€ completion_providers.py      # Provider implementations
â”‚   â”‚   â”œâ”€â”€ fuzzy_matcher.py             # Fuzzy matching algorithm
â”‚   â”‚   â””â”€â”€ snippet_manager.py           # Snippet expansion logic
â”‚   â””â”€â”€ models.py                         # Add CompletionResult model
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ autocomplete_manager.py          # Qt integration layer
â””â”€â”€ tests/unit/core/completion/
    â”œâ”€â”€ test_completion_engine.py        # Engine tests
    â”œâ”€â”€ test_completion_context.py       # Context analysis tests
    â”œâ”€â”€ test_completion_providers.py     # Provider tests
    â”œâ”€â”€ test_fuzzy_matcher.py            # Fuzzy matching tests
    â””â”€â”€ test_snippet_manager.py          # Snippet tests
```

---

## Data Models

### CompletionResult

```python
@dataclass
class CompletionResult:
    """Single completion suggestion."""

    text: str                    # Completion text to insert
    display: str                 # Text shown in popup
    description: str = ""        # Detailed description
    category: str = "syntax"     # Category: syntax, attribute, xref, include, snippet
    score: float = 0.0          # Relevance score (0-1)
    replace_length: int = 0     # Characters to replace before cursor
    cursor_offset: int = 0      # Cursor position after insertion (0 = end)
    icon: Optional[str] = None  # Icon identifier for UI
```

### CompletionContext

```python
@dataclass
class CompletionContext:
    """Context information for completion request."""

    text_before_cursor: str      # Text before cursor (up to 100 chars)
    text_after_cursor: str       # Text after cursor (up to 20 chars)
    line_text: str               # Full current line
    cursor_position: int         # Absolute cursor position
    line_number: int             # Current line number
    column: int                  # Column number
    trigger_char: Optional[str]  # Character that triggered completion (: [ <)
    document_path: Optional[Path] # Current document path (for includes)
```

---

## Implementation Phases

### Phase 1: Core Engine (8-10h)

**Deliverables:**
- `completion_engine.py` with context analysis
- `completion_context.py` with context extraction
- `fuzzy_matcher.py` with matching algorithm
- Basic unit tests (30+ tests)

**Key Methods:**
- `CompletionEngine.get_completions(context: CompletionContext) -> List[CompletionResult]`
- `CompletionContext.from_editor(editor: QPlainTextEdit) -> CompletionContext`
- `FuzzyMatcher.score(query: str, candidate: str) -> float`

**Success Criteria:**
- Context extraction accurate for all trigger types
- Fuzzy matching returns correct scores
- Engine returns ranked results in <10ms

### Phase 2: Providers (8-10h)

**Deliverables:**
- `completion_providers.py` with 4 providers:
  1. `SyntaxProvider` - headings, lists, blocks, inline
  2. `AttributeProvider` - document + custom attributes
  3. `CrossRefProvider` - section IDs, anchors
  4. `IncludeProvider` - file paths
- Provider tests (25+ tests)

**Key Methods:**
- `BaseProvider.get_completions(context: CompletionContext) -> List[CompletionResult]`
- `BaseProvider.is_applicable(context: CompletionContext) -> bool`

**Success Criteria:**
- Each provider returns relevant suggestions
- Providers correctly detect when they're applicable
- All providers tested with edge cases

### Phase 3: Qt Integration (6-8h)

**Deliverables:**
- `autocomplete_manager.py` with QCompleter integration
- Editor modifications in `line_number_area.py`
- Settings integration for enable/disable
- UI tests (15+ tests)

**Key Methods:**
- `AutoCompleteManager.show_completion(completions: List[CompletionResult])`
- `AutoCompleteManager.handle_selection(result: CompletionResult)`
- `LineNumberedTextEdit.keyPressEvent()` - trigger detection

**Success Criteria:**
- Ctrl+Space shows completion popup
- Auto-triggers work for `:`, `[`, `<`
- Selection inserts correct text
- Escape dismisses popup

### Phase 4: Snippets (2-4h)

**Deliverables:**
- `snippet_manager.py` with snippet expansion
- Built-in snippet library (10+ snippets)
- Snippet tests (10+ tests)

**Snippets:**
- `table3x3` â†’ 3x3 table template
- `codeblock` â†’ Source block with language
- `noteblock` â†’ NOTE admonition
- `tipblock` â†’ TIP admonition
- `warningblock` â†’ WARNING admonition
- `cautionblock` â†’ CAUTION admonition
- `importantblock` â†’ IMPORTANT admonition
- `exampleblock` â†’ Example block
- `sidebarblock` â†’ Sidebar block
- `quoteblock` â†’ Quote block with attribution

**Success Criteria:**
- Snippets expand correctly
- Cursor positioned appropriately after expansion
- Tab stops work (if implemented)

---

## Performance Optimization

### Strategy

1. **Lazy Loading**
   - Load completion data only when first triggered
   - Cache compiled completion lists

2. **Incremental Updates**
   - Update cross-reference index only on save/edit
   - Don't re-scan document on every keystroke

3. **Result Caching**
   - Cache last 10 completion results
   - Invalidate cache on context change

4. **Async Providers** (if needed)
   - File system scanning for includes (background thread)
   - Document indexing for cross-refs (on save)

### Performance Budget

| Operation | Target | Max |
|-----------|--------|-----|
| Context extraction | <1ms | 2ms |
| Provider query (each) | <5ms | 10ms |
| Fuzzy matching (per item) | <0.01ms | 0.05ms |
| Result ranking | <2ms | 5ms |
| Total response time | <25ms | 50ms |

---

## Testing Strategy

### Unit Tests (75+ tests)

1. **CompletionEngine** (15 tests)
   - Context analysis for each trigger type
   - Provider coordination
   - Result ranking and filtering

2. **CompletionContext** (10 tests)
   - Context extraction from editor
   - Edge cases (start/end of document, empty lines)

3. **FuzzyMatcher** (15 tests)
   - Exact matches, prefix matches, fuzzy matches
   - Score calculation accuracy
   - Performance with large candidate lists

4. **Providers** (25 tests)
   - Each provider: applicability, suggestions, edge cases
   - Provider interaction (multiple applicable)

5. **SnippetManager** (10 tests)
   - Snippet expansion
   - Cursor positioning
   - Tab stops (if implemented)

### Integration Tests (10 tests)

- Full workflow: trigger â†’ query â†’ display â†’ select â†’ insert
- Multiple trigger types
- Settings enable/disable

### Performance Tests (5 tests)

- Response time <50ms under load
- Memory usage <5MB
- No startup time regression

---

## User Experience

### Keyboard Shortcuts

- `Ctrl+Space` - Show completion popup (manual trigger)
- `â†‘` / `â†“` - Navigate suggestions
- `Enter` - Accept selected suggestion
- `Tab` - Accept selected suggestion (alternative)
- `Escape` - Dismiss popup
- Auto-triggers: `:` (attributes), `[` (blocks), `<` (xrefs)

### Visual Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— heading1       Heading Level 1   â”‚ â† Selected
â”‚ â— heading2       Heading Level 2   â”‚
â”‚ â— heading3       Heading Level 3   â”‚
â”‚ â—† :author:       Document Attributeâ”‚
â”‚ â—† :revnumber:    Version Number    â”‚
â”‚ â–² <<intro>>      Cross-Reference   â”‚
â”‚ â—€ include::f...  Include File      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Icon  Text         Description
```

### Settings Integration

```python
# Settings model additions
autocomplete_enabled: bool = True
autocomplete_auto_trigger: bool = True
autocomplete_trigger_delay_ms: int = 100
autocomplete_max_results: int = 20
autocomplete_fuzzy_threshold: float = 0.3
```

---

## Migration & Rollout

### Release Strategy

1. **Alpha (internal testing)**
   - Feature flag: `ENABLE_AUTOCOMPLETE=false` by default
   - Manual testing with sample documents
   - Performance profiling

2. **Beta (opt-in)**
   - Settings option to enable (default: off)
   - User feedback collection
   - Bug fixes and refinements

3. **GA (general availability)**
   - Default: enabled
   - Documentation and tutorials
   - Announce in release notes

### Documentation

- User guide: "Using Auto-Complete" section
- Developer guide: "Extending Auto-Complete" (future)
- SPECIFICATIONS.md: Add auto-complete rules
- CHANGELOG.md: Feature announcement

---

## Risks & Mitigation

### Risk 1: Performance Impact

**Risk:** Auto-complete adds latency to typing.

**Mitigation:**
- Debounce auto-triggers (100ms delay)
- Async provider queries if needed
- Performance budget enforcement
- Continuous profiling during development

### Risk 2: False Positives

**Risk:** Irrelevant suggestions shown.

**Mitigation:**
- Context-aware provider applicability
- Fuzzy matching threshold tuning
- User feedback loop for refinement
- Easy dismiss (Escape key)

### Risk 3: Complexity Creep

**Risk:** Feature becomes overly complex.

**Mitigation:**
- Start with core syntax only
- Iterative enhancement
- Feature flagging for gradual rollout
- Keep snippet system simple initially

---

## Success Metrics

### Quantitative

- Response time: <50ms (target: <25ms) âœ…
- Test coverage: 100% âœ…
- Memory usage: <5MB âœ…
- Startup time: No regression (maintain <1.1s) âœ…
- User adoption: >50% enabled after 1 month

### Qualitative

- User feedback: Positive sentiment
- Bug reports: <5 critical bugs
- Performance complaints: None
- Community interest: GitHub stars/forks increase

---

## Future Enhancements (Post-v2.0.0)

1. **Custom Snippets**
   - User-defined snippets in settings
   - Snippet editor UI
   - Import/export snippet libraries

2. **LSP Integration** (v3.0.0)
   - Language Server Protocol for AsciiDoc
   - Advanced semantic completions
   - Document symbols and outline

3. **AI-Powered Suggestions** (v3.0+)
   - Context-aware text generation
   - Style recommendations
   - Grammar and clarity suggestions

4. **Collaborative Completions**
   - Team snippet libraries
   - Shared custom completions
   - Organizational standards enforcement

---

## References

### Qt Documentation

- [QCompleter Class Reference](https://doc.qt.io/qt-6/qcompleter.html)
- [QAbstractItemModel](https://doc.qt.io/qt-6/qabstractitemmodel.html)
- [QPlainTextEdit](https://doc.qt.io/qt-6/qplaintextedit.html)

### AsciiDoc Documentation

- [AsciiDoc Syntax Quick Reference](https://docs.asciidoctor.org/asciidoc/latest/syntax-quick-reference/)
- [AsciiDoc Attributes](https://docs.asciidoctor.org/asciidoc/latest/attributes/document-attributes-reference/)

### Similar Implementations

- VSCode IntelliSense architecture
- JetBrains IDE completion system
- Sublime Text completions

---

**Next Steps:**

1. âœ… Create this plan document
2. Review and refine architecture with stakeholders
3. Set up development branch: `feature/v2.0.0-autocomplete`
4. Begin Phase 1: Core Engine implementation
5. Iterate based on testing and feedback

---

**Last Updated:** November 5, 2025
**Author:** Test Coverage & v2.0.0 Development Initiative
**Status:** ðŸ“‹ PLANNING â†’ Ready for Phase 1 Implementation
