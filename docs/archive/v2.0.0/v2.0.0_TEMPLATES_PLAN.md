# v2.0.0 Templates Implementation Plan

**Feature:** Document Templates with Variable Substitution
**Actual Effort:** 16-24 hours
**Status:** âœ… COMPLETED
**Created:** November 8, 2025
**Completed:** November 9, 2025

---

## Table of Contents

1. [Overview](#overview)
2. [Requirements](#requirements)
3. [Template Format](#template-format)
4. [Architecture](#architecture)
5. [Implementation Phases](#implementation-phases)
6. [API Design](#api-design)
7. [Built-in Templates](#built-in-templates)
8. [Test Strategy](#test-strategy)
9. [User Experience](#user-experience)

---

## Overview

### Goals

Build a template system that:
- Provides 8 built-in document templates
- Supports custom user templates
- Variable substitution with defaults
- Template browser with live preview
- <50ms instantiation

### User Benefits

- **Quick start** with pre-structured documents
- **Consistency** across team documents
- **Best practices** baked into templates
- **Customization** for specific workflows

---

## Requirements

### Functional Requirements

1. **Built-in Templates (8)**
   - Article - Short technical article
   - Book - Multi-chapter book with TOC
   - Man Page - Unix manual page format
   - Report - Formal technical report
   - README - GitHub-style README
   - Notes - Simple note-taking
   - Tutorial - Step-by-step guide
   - API Documentation - API reference

2. **Template Format**
   - YAML front matter for metadata
   - Variable substitution: `{{variable}}`
   - Default values: `{{variable:default}}`
   - Conditional sections: `{{#if condition}}...{{/if}}`
   - Includes: `{{include:file.adoc}}`

3. **Template Management**
   - Load built-in templates
   - Load custom templates from directory
   - Create new template from current document
   - Edit/delete custom templates
   - Import/export templates

4. **Template Browser**
   - Grid or list view with thumbnails
   - Category filter (article, book, report, etc.)
   - Search by name/description
   - Live preview pane
   - Recent templates list

### Non-Functional Requirements

1. **Performance**
   - <50ms template instantiation
   - <100ms preview rendering
   - <200ms template browser load

2. **UX**
   - Keyboard navigation in browser
   - Variable input form with validation
   - Tooltip help for each variable
   - Undo template application

3. **Storage**
   - Built-in: `src/asciidoc_artisan/templates/`
   - Custom: `~/.config/AsciiDocArtisan/templates/`
   - Format: `.adoc` files with YAML front matter

---

## Template Format

### Example Template

```yaml
---
name: Technical Article
category: article
description: Short technical article with abstract and references
author: AsciiDoc Artisan
version: 1.0
variables:
  - name: title
    description: Article title
    required: true
  - name: author
    description: Author name
    default: "{{user.name}}"
  - name: date
    description: Publication date
    default: "{{today}}"
  - name: abstract
    description: Include abstract section
    type: boolean
    default: true
---
= {{title}}
{{author}}
{{date}}
:toc:
:icons: font

{{#if abstract}}
[abstract]
--
Write your abstract here. Summarize the main points of your article in 2-3 sentences.
--
{{/if}}

== Introduction

Write your introduction here. Explain the context and motivation for your article.

== Main Content

=== Section 1

Content for section 1.

=== Section 2

Content for section 2.

== Conclusion

Summarize your findings and provide next steps.

== References

* Reference 1
* Reference 2
```

### Variable Syntax

| Syntax | Description | Example |
|--------|-------------|---------|
| `{{var}}` | Simple variable | `{{title}}` â†’ "My Article" |
| `{{var:default}}` | With default | `{{author:Anonymous}}` â†’ "Anonymous" |
| `{{#if var}}...{{/if}}` | Conditional | Show section if var is true |
| `{{#unless var}}...{{/unless}}` | Negative conditional | Show if var is false |
| `{{include:file}}` | Include file | Insert file contents |

### Built-in Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `{{user.name}}` | Current user name | "John Doe" |
| `{{user.email}}` | Current user email | "john@example.com" |
| `{{today}}` | Today's date | "2025-11-08" |
| `{{year}}` | Current year | "2025" |
| `{{app.name}}` | App name | "AsciiDoc Artisan" |
| `{{app.version}}` | App version | "2.0.0" |

---

## Architecture

### Components

```
core/
â”œâ”€â”€ template_engine.py      # Variable substitution and rendering
â”œâ”€â”€ template_manager.py     # Template CRUD operations
â””â”€â”€ models.py               # Template, TemplateVariable dataclasses

ui/
â”œâ”€â”€ template_browser.py     # Template selection dialog
â”œâ”€â”€ template_variable_dialog.py  # Variable input form
â””â”€â”€ template_manager_ui.py  # Template management (create/edit/delete)

templates/                  # Built-in template files
â”œâ”€â”€ article.adoc
â”œâ”€â”€ book.adoc
â”œâ”€â”€ man-page.adoc
â”œâ”€â”€ report.adoc
â”œâ”€â”€ readme.adoc
â”œâ”€â”€ notes.adoc
â”œâ”€â”€ tutorial.adoc
â””â”€â”€ api-docs.adoc
```

### Data Flow

```
User â†’ File â†’ New from Template
    â†“
TemplateBrowser.show_dialog()
    â†“
User selects template â†’ TemplateVariableDialog.show_dialog()
    â†“
User fills variables â†’ OK
    â†“
TemplateEngine.instantiate(template, variables)
    â†“
Parse YAML front matter
    â†“
Apply variable substitution
    â†“
Process conditionals ({{#if}}, {{#unless}})
    â†“
Process includes ({{include:}})
    â†“
Return rendered document
    â†“
Editor.setText(rendered_document)
```

### Thread Safety

- **Engine:** Stateless, thread-safe
- **Manager:** File I/O via AsyncFileHandler
- **Browser:** Main thread only (Qt requirement)

---

## Implementation Phases

### Phase 1: Core Engine (6-8h)

**Goal:** Build template rendering engine

**Files:**
- `core/template_engine.py`
- `core/models.py` (Template, TemplateVariable)

**Features:**
- YAML front matter parsing
- Variable substitution ({{var}}, {{var:default}})
- Built-in variable resolution ({{today}}, {{user.name}})
- Error handling (missing variables, invalid syntax)

**Tests:** 30 unit tests
- Parsing: YAML extraction, variable detection
- Substitution: simple, with defaults, missing vars
- Built-in vars: all built-in variables work
- Edge cases: empty template, no variables, invalid YAML

### Phase 2: Manager (4-6h)

**Goal:** Template file management

**Files:**
- `core/template_manager.py`

**Features:**
- Load templates from directories (built-in + custom)
- CRUD operations (create, read, update, delete)
- Template validation
- Recent templates tracking
- Import/export templates

**Tests:** 20 unit tests
- Loading: built-in, custom, multiple directories
- CRUD: create template, edit, delete, read
- Validation: required fields, valid YAML
- Recent: add to recent, limit size
- Import/export: file operations

### Phase 3: Browser UI (4-6h)

**Goal:** Template selection interface

**Files:**
- `ui/template_browser.py`
- `ui/template_variable_dialog.py`

**Features:**
- Grid view with template cards
- Category filter dropdown
- Search bar
- Live preview pane (right side)
- Variable input dialog with validation
- Keyboard navigation (arrows, Enter, Escape)

**Tests:** 15 Qt tests
- Browser: show templates, filter, search
- Selection: single-click preview, double-click select
- Variable dialog: show variables, validation, defaults
- Keyboard: navigation, selection, cancel

### Phase 4: Built-in Templates (2-4h)

**Goal:** Create 8 production-ready templates

**Files:**
- `templates/*.adoc` (8 template files)

**Templates:**
1. Article (technical article)
2. Book (multi-chapter book)
3. Man Page (Unix manual)
4. Report (formal report)
5. README (GitHub README)
6. Notes (simple notes)
7. Tutorial (step-by-step guide)
8. API Docs (API reference)

**Tests:** 15 integration tests
- Each template: instantiation, variables work
- Edge cases: optional variables, conditionals

---

## API Design

### Template

```python
from dataclasses import dataclass
from typing import List, Dict, Any, Optional

@dataclass
class TemplateVariable:
    """Template variable definition"""
    name: str                    # Variable name
    description: str             # Help text
    required: bool = False       # Required variable
    default: Optional[str] = None  # Default value
    type: str = "string"         # string, boolean, number

@dataclass
class Template:
    """Document template"""
    name: str                    # Template name
    category: str                # article, book, report, etc.
    description: str             # Short description
    author: str = ""             # Template author
    version: str = "1.0"         # Template version
    variables: List[TemplateVariable] = None  # Variable definitions
    content: str = ""            # Template content (after YAML)
    file_path: Optional[str] = None  # Source file path

    def __post_init__(self) -> None:
        if self.variables is None:
            self.variables = []
```

### TemplateEngine

```python
import re
from typing import Dict, Any
from datetime import date

class TemplateEngine:
    """Template rendering engine"""

    def __init__(self) -> None:
        self.built_in_vars = self._get_built_in_vars()

    def _get_built_in_vars(self) -> Dict[str, str]:
        """Get built-in variable values"""
        import os
        return {
            'user.name': os.environ.get('USER', 'Unknown'),
            'user.email': os.environ.get('EMAIL', ''),
            'today': date.today().strftime('%Y-%m-%d'),
            'year': str(date.today().year),
            'app.name': 'AsciiDoc Artisan',
            'app.version': '2.0.0',
        }

    def instantiate(
        self,
        template: Template,
        variables: Dict[str, Any]
    ) -> str:
        """
        Render template with variables.

        Args:
            template: Template to render
            variables: User-provided variable values

        Returns:
            Rendered document text

        Raises:
            ValueError: If required variable missing
        """
        # Check required variables
        for var_def in template.variables:
            if var_def.required and var_def.name not in variables:
                raise ValueError(f"Required variable '{var_def.name}' not provided")

        # Merge user variables with built-in vars
        all_vars = {**self.built_in_vars, **variables}

        # Apply defaults for missing variables
        for var_def in template.variables:
            if var_def.name not in all_vars and var_def.default:
                all_vars[var_def.name] = var_def.default

        # Render template
        rendered = template.content

        # Process conditionals first ({{#if var}}...{{/if}})
        rendered = self._process_conditionals(rendered, all_vars)

        # Process includes ({{include:file}})
        rendered = self._process_includes(rendered)

        # Substitute variables ({{var}}, {{var:default}})
        rendered = self._substitute_variables(rendered, all_vars)

        return rendered

    def _substitute_variables(self, text: str, variables: Dict[str, Any]) -> str:
        """Replace {{var}} and {{var:default}} with values"""
        # Pattern: {{varname}} or {{varname:default}}
        pattern = r'\{\{([^}:]+)(?::([^}]+))?\}\}'

        def replace(match: re.Match) -> str:
            var_name = match.group(1).strip()
            default = match.group(2).strip() if match.group(2) else ''

            # Look up variable
            value = variables.get(var_name, default)

            # Convert boolean to string
            if isinstance(value, bool):
                return 'true' if value else ''

            return str(value)

        return re.sub(pattern, replace, text)

    def _process_conditionals(self, text: str, variables: Dict[str, Any]) -> str:
        """Process {{#if var}}...{{/if}} and {{#unless var}}...{{/unless}}"""
        # Pattern: {{#if var}}...{{/if}}
        if_pattern = r'\{\{#if\s+(\w+)\}\}(.*?)\{\{/if\}\}'

        def replace_if(match: re.Match) -> str:
            var_name = match.group(1)
            content = match.group(2)
            var_value = variables.get(var_name, False)

            # Include content if var is truthy
            return content if self._is_truthy(var_value) else ''

        text = re.sub(if_pattern, replace_if, text, flags=re.DOTALL)

        # Pattern: {{#unless var}}...{{/unless}}
        unless_pattern = r'\{\{#unless\s+(\w+)\}\}(.*?)\{\{/unless\}\}'

        def replace_unless(match: re.Match) -> str:
            var_name = match.group(1)
            content = match.group(2)
            var_value = variables.get(var_name, False)

            # Include content if var is falsy
            return content if not self._is_truthy(var_value) else ''

        text = re.sub(unless_pattern, replace_unless, text, flags=re.DOTALL)

        return text

    def _process_includes(self, text: str) -> str:
        """Process {{include:file}} directives"""
        pattern = r'\{\{include:([^}]+)\}\}'

        def replace(match: re.Match) -> str:
            file_path = match.group(1).strip()

            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    return f.read()
            except FileNotFoundError:
                return f"[ERROR: File not found: {file_path}]"
            except Exception as e:
                return f"[ERROR: Cannot read file: {e}]"

        return re.sub(pattern, replace, text)

    def _is_truthy(self, value: Any) -> bool:
        """Check if value is truthy"""
        if isinstance(value, bool):
            return value
        if isinstance(value, str):
            return value.lower() not in ('', 'false', '0', 'no')
        return bool(value)

    def parse_template(self, file_path: str) -> Template:
        """
        Parse template file.

        Args:
            file_path: Path to template file

        Returns:
            Template object

        Raises:
            ValueError: If invalid template format
        """
        import yaml

        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # Check for YAML front matter
        if not content.startswith('---'):
            raise ValueError("Template must start with YAML front matter (---)")

        # Split front matter from content
        parts = content.split('---', 2)
        if len(parts) < 3:
            raise ValueError("Invalid YAML front matter format")

        yaml_text = parts[1]
        template_content = parts[2].lstrip('\n')

        # Parse YAML
        try:
            metadata = yaml.safe_load(yaml_text)
        except yaml.YAMLError as e:
            raise ValueError(f"Invalid YAML: {e}")

        # Extract required fields
        name = metadata.get('name')
        category = metadata.get('category')
        description = metadata.get('description')

        if not all([name, category, description]):
            raise ValueError("Template must have name, category, and description")

        # Parse variables
        var_defs = metadata.get('variables', [])
        variables = [
            TemplateVariable(
                name=v['name'],
                description=v.get('description', ''),
                required=v.get('required', False),
                default=v.get('default'),
                type=v.get('type', 'string'),
            )
            for v in var_defs
        ]

        return Template(
            name=name,
            category=category,
            description=description,
            author=metadata.get('author', ''),
            version=metadata.get('version', '1.0'),
            variables=variables,
            content=template_content,
            file_path=file_path,
        )
```

### TemplateManager

```python
from pathlib import Path
from typing import List, Dict
import json

class TemplateManager:
    """Manages template files"""

    def __init__(self, engine: TemplateEngine) -> None:
        self.engine = engine
        self.built_in_dir = Path(__file__).parent.parent / 'templates'
        self.custom_dir = self._get_custom_dir()
        self.templates: Dict[str, Template] = {}
        self.recent: List[str] = []  # Template names
        self.max_recent = 10

        # Load templates
        self._load_templates()
        self._load_recent()

    def _get_custom_dir(self) -> Path:
        """Get custom template directory"""
        from PySide6.QtCore import QStandardPaths
        config_dir = QStandardPaths.writableLocation(QStandardPaths.AppDataLocation)
        custom_dir = Path(config_dir) / 'templates'
        custom_dir.mkdir(parents=True, exist_ok=True)
        return custom_dir

    def _load_templates(self) -> None:
        """Load all templates from directories"""
        self.templates = {}

        # Load built-in templates
        for file_path in self.built_in_dir.glob('*.adoc'):
            try:
                template = self.engine.parse_template(str(file_path))
                self.templates[template.name] = template
            except Exception as e:
                import logging
                logging.error(f"Failed to load template {file_path}: {e}")

        # Load custom templates
        for file_path in self.custom_dir.glob('*.adoc'):
            try:
                template = self.engine.parse_template(str(file_path))
                self.templates[template.name] = template
            except Exception as e:
                import logging
                logging.error(f"Failed to load custom template {file_path}: {e}")

    def get_all_templates(self) -> List[Template]:
        """Get all available templates"""
        return list(self.templates.values())

    def get_template(self, name: str) -> Optional[Template]:
        """Get template by name"""
        return self.templates.get(name)

    def get_templates_by_category(self, category: str) -> List[Template]:
        """Get templates in category"""
        return [t for t in self.templates.values() if t.category == category]

    def get_categories(self) -> List[str]:
        """Get all template categories"""
        return sorted(set(t.category for t in self.templates.values()))

    def add_to_recent(self, template_name: str) -> None:
        """Add template to recent list"""
        if template_name in self.recent:
            self.recent.remove(template_name)
        self.recent.insert(0, template_name)
        self.recent = self.recent[:self.max_recent]
        self._save_recent()

    def get_recent_templates(self) -> List[Template]:
        """Get recently used templates"""
        templates = []
        for name in self.recent:
            if name in self.templates:
                templates.append(self.templates[name])
        return templates

    def _load_recent(self) -> None:
        """Load recent templates from file"""
        recent_file = self.custom_dir / 'recent.json'
        if recent_file.exists():
            try:
                with open(recent_file, 'r') as f:
                    self.recent = json.load(f)
            except Exception:
                self.recent = []

    def _save_recent(self) -> None:
        """Save recent templates to file"""
        recent_file = self.custom_dir / 'recent.json'
        try:
            with open(recent_file, 'w') as f:
                json.dump(self.recent, f)
        except Exception as e:
            import logging
            logging.error(f"Failed to save recent templates: {e}")
```

---

## Built-in Templates

### 1. Article Template

**Category:** article
**Description:** Short technical article with abstract and references
**Variables:** title, author, date, abstract (boolean), toc (boolean)

### 2. Book Template

**Category:** book
**Description:** Multi-chapter book with table of contents
**Variables:** title, author, date, chapters (number), toc_depth (number)

### 3. Man Page Template

**Category:** man-page
**Description:** Unix manual page format
**Variables:** name, section, description, synopsis, author

### 4. Report Template

**Category:** report
**Description:** Formal technical report
**Variables:** title, author, date, organization, report_number, classification

### 5. README Template

**Category:** readme
**Description:** GitHub-style README
**Variables:** project_name, description, license, installation, usage

### 6. Notes Template

**Category:** notes
**Description:** Simple note-taking document
**Variables:** title, date, tags

### 7. Tutorial Template

**Category:** tutorial
**Description:** Step-by-step tutorial guide
**Variables:** title, author, difficulty, prerequisites, duration

### 8. API Documentation Template

**Category:** api-docs
**Description:** API reference documentation
**Variables:** api_name, version, base_url, authentication

---

## Test Strategy

### Unit Tests (65 tests)

**TemplateEngine (40 tests):**
- Parsing: YAML extraction, variable detection (10 tests)
- Substitution: simple, defaults, built-in vars (15 tests)
- Conditionals: if/unless, nested, edge cases (10 tests)
- Includes: file loading, error handling (5 tests)

**TemplateManager (25 tests):**
- Loading: built-in, custom, error handling (8 tests)
- CRUD: create, read, update, delete (8 tests)
- Recent: add, remove, limit, persistence (5 tests)
- Categories: list, filter (4 tests)

### Integration Tests (15 tests)

**Qt UI Tests:**
- Browser: show, filter, search, select (7 tests)
- Variable dialog: show, validation, defaults (5 tests)
- End-to-end: select template â†’ fill vars â†’ instantiate (3 tests)

**Total: 80 tests**

---

## User Experience

### Template Browser

**Layout:**
```
+---------------------------------------------+
| Template Browser                        [X] |
+---------------------------------------------+
| Category: [All v] | Search: [_______]  [?] |
+---------------------------------------------+
| +---------+  +---------+  +---------+       |
| | Article |  | Book    |  | Report  |       |
| | [icon]  |  | [icon]  |  | [icon]  |       |
| +---------+  +---------+  +---------+       |
| +---------+  +---------+                    |
| | README  |  | Tutorial|                    |
| | [icon]  |  | [icon]  |                    |
| +---------+  +---------+                    |
+---------------------------------------------+
| Preview:                                    |
| = My Article                                |
| John Doe                                    |
| 2025-11-08                                  |
| :toc:                                       |
|                                             |
| == Introduction                             |
| ...                                         |
+---------------------------------------------+
| [Create New Template]  [OK]  [Cancel]       |
+---------------------------------------------+
```

### Variable Input Dialog

```
+-------------------------------------+
| Template Variables: Article      [X]|
+-------------------------------------+
| Title: [_____________________]  *   |
|        Document title               |
+-------------------------------------+
| Author: [John Doe____________]      |
|         Author name                 |
+-------------------------------------+
| Date: [2025-11-08___________]       |
|       Publication date              |
+-------------------------------------+
| [x] Include abstract section        |
+-------------------------------------+
| [x] Include table of contents       |
+-------------------------------------+
|                    [OK]  [Cancel]   |
+-------------------------------------+
```

### Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Ctrl+N` | New from template (opens browser) |
| `Arrow Keys` | Navigate template grid |
| `Enter` | Select template |
| `Escape` | Cancel |
| `/` or `Ctrl+F` | Focus search box |

---

## Settings Integration

```python
# In core/settings.py

template_default_category: str = "all"
template_show_preview: bool = True
template_recent_max: int = 10
template_custom_dir: str = ""  # Override custom template directory
```

---

## Next Steps

1. âœ… Create detailed plan
2. ðŸ“‹ Implement Phase 1: Core Engine (6-8h)
3. ðŸ“‹ Implement Phase 2: Manager (4-6h)
4. ðŸ“‹ Implement Phase 3: Browser UI (4-6h)
5. ðŸ“‹ Implement Phase 4: Built-in Templates (2-4h)
6. ðŸ“‹ Write documentation
7. ðŸ“‹ Integration testing

---

**Last Updated:** November 8, 2025
**Owner:** AsciiDoc Artisan Development Team
**Status:** Ready for Implementation
